<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Автосервис</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .order-item {
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .overdue-order {
            border-left: 4px solid red;
            background-color: #fff5f5;
        }
        .completed-order {
            border-left: 4px solid green;
            background-color: #f5fff5;
        }
        .category-badge {
            font-size: 0.8em;
            margin-right: 5px;
        }
        .comment-section {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        .comment {
            padding: 8px;
            margin-bottom: 5px;
            background: white;
            border-radius: 3px;
            border-left: 3px solid #007bff;
        }
        .search-box {
            max-width: 400px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <h1 class="mb-4">
        <i class="fas fa-car"></i> Автосервис
    </h1>

    <!-- Информация о пользователе -->
    <div class="alert alert-info mb-4">
        <i class="fas fa-user"></i> Вы вошли как:
        <strong><span sec:authentication="name">Username</span></strong>
        <span sec:authorize="hasRole('CLIENT')">(Клиент)</span>
        <span sec:authorize="hasRole('RECEPTION')">(Приемщик)</span>
        <span sec:authorize="hasRole('MECHANIC')">(Механик)</span>
        <span sec:authorize="hasRole('MANAGER')">(Менеджер)</span>
        <span sec:authorize="hasRole('ADMIN')">(Администратор)</span>
        <form th:action="@{/logout}" method="post" class="d-inline float-end">
            <button type="submit" class="btn btn-outline-danger btn-sm">
                <i class="fas fa-sign-out-alt"></i> Выйти
            </button>
        </form>
    </div>

    <!-- Поиск по заказам -->
    <div class="search-box" sec:authorize="!hasRole('CLIENT')">
        <form th:action="@{/orders}" method="get" class="d-flex">
            <input type="text" name="search" class="form-control me-2"
                   placeholder="Поиск по клиенту, автомобилю или описанию..." th:value="${search}">
            <button type="submit" class="btn btn-outline-primary">
                <i class="fas fa-search"></i>
            </button>
        </form>
    </div>

    <!-- Блок управления категориями - ТОЛЬКО через th:if -->
    <div th:if="${canManageCategories}">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-tags"></i> Управление категориями</h5>
            </div>
            <div class="card-body">
                <form th:action="@{/addCategory}" method="post" class="d-flex mb-3">
                    <input type="text" name="name" class="form-control me-2" placeholder="Название новой категории" required>
                    <input type="color" name="color" class="form-control-color me-2" value="#007bff" title="Выберите цвет категории">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus"></i> Добавить категорию
                    </button>
                </form>
                <div class="d-flex flex-wrap gap-2">
                    <span th:each="category : ${categories}"
                          class="badge category-badge"
                          th:style="'background-color: ' + ${category.color}"
                          th:text="${category.name}">
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Список заказов -->
    <div class="orders-list">
        <div th:each="order : ${orders}"
             th:class="${order.overdue} ? 'order-item overdue-order' : (${order.completed} ? 'order-item completed-order' : 'order-item')">

            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <h4>
                        <i class="fas fa-car"></i>
                        <span th:text="${order.carModel} + ' (' + ${order.licensePlate} + ')'"></span>
                    </h4>
                    <div class="d-flex align-items-center gap-2">
                        <span th:class="${order.completed} ? 'badge bg-success' : 'badge bg-warning'"
                              th:text="${order.completed} ? 'Выполнено' : 'В работе'">
                        </span>
                        <span th:if="${order.category}"
                              class="badge category-badge"
                              th:style="'background-color: ' + ${order.category.color}"
                              th:text="${order.category.name}">
                        </span>
                    </div>
                </div>
                <div class="text-end">
                    <div th:if="${order.deadline != null}">
                        <strong>Срок:</strong>
                        <span th:class="${order.overdue} ? 'text-danger' : ''"
                              th:text="${#temporals.format(order.deadline, 'dd.MM.yyyy HH:mm')}">
                        </span>
                    </div>
                    <div th:if="${order.cost > 0}">
                        <strong>Стоимость:</strong>
                        <span th:text="${order.cost} + ' руб.'"></span>
                    </div>
                </div>
            </div>

            <p><strong><i class="fas fa-user"></i> Клиент:</strong> <span th:text="${order.clientName}"></span></p>
            <p><strong><i class="fas fa-tools"></i> Описание работ:</strong> <span th:text="${order.description}"></span></p>

            <div th:if="${order.assignedMechanic}" sec:authorize="!hasRole('CLIENT')">
                <strong><i class="fas fa-user-cog"></i> Механик:</strong> <span th:text="${order.assignedMechanic}"></span>
            </div>

            <!-- Комментарии -->
            <div class="comment-section" th:if="${not #lists.isEmpty(order.comments)}">
                <h6><i class="fas fa-comments"></i> Комментарии:</h6>
                <div th:each="comment : ${order.comments}" class="comment">
                    <div class="d-flex justify-content-between">
                        <strong th:text="${comment.author}"></strong>
                        <small class="text-muted" th:text="${#temporals.format(comment.createdAt, 'dd.MM.yyyy HH:mm')}"></small>
                    </div>
                    <p class="mb-0" th:text="${comment.text}"></p>
                </div>
            </div>

            <!-- Форма добавления комментария - доступна всем кроме CLIENT -->
            <form th:action="@{/addComment/{id}(id=${order.id})}" method="post" class="mt-3" sec:authorize="!hasRole('CLIENT')">
                <div class="input-group">
                    <input type="text" name="text" class="form-control" placeholder="Добавить комментарий..." required>
                    <button type="submit" class="btn btn-outline-primary">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </form>

            <!-- Кнопки действий с ролевым доступом -->
            <div class="order-actions mt-3 pt-3 border-top" sec:authorize="!hasRole('CLIENT')">
                <div class="btn-group" role="group">
                    <!-- Кнопка удаления - только MANAGER и ADMIN -->
                    <button type="button" class="btn btn-danger btn-sm"
                            data-bs-toggle="modal" data-bs-target="#deleteModal"
                            th:attr="data-bs-order-id=${order.id}, data-bs-order-title=${order.carModel + ' (' + order.licensePlate + ')'}"
                            sec:authorize="hasRole('MANAGER') or hasRole('ADMIN')">
                        <i class="fas fa-trash"></i> Удалить
                    </button>

                    <!-- Смена статуса - MECHANIC, MANAGER, ADMIN -->
                    <form th:action="@{/updateOrderStatus/{id}(id=${order.id})}"
                          method="post" class="d-inline"
                          sec:authorize="hasRole('MECHANIC') or hasRole('MANAGER') or hasRole('ADMIN')">
                        <input type="hidden" name="completed" th:value="${!order.completed}">
                        <button type="submit" class="btn btn-success btn-sm">
                            <i class="fas" th:class="${order.completed} ? 'fa-redo' : 'fa-check'"></i>
                            <span th:text="${order.completed} ? 'Возобновить' : 'Завершить'"></span>
                        </button>
                    </form>

                    <!-- Обновление срока - только MANAGER и ADMIN -->
                    <form th:action="@{/updateDeadline/{id}(id=${order.id})}"
                          method="post" class="d-inline"
                          sec:authorize="hasRole('MANAGER') or hasRole('ADMIN')">
                        <input type="datetime-local" name="newDeadline" class="form-control-sm me-2">
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="fas fa-calendar"></i> Срок
                        </button>
                    </form>

                    <!-- Выбор категории - доступен всем кроме CLIENT -->
                    <form th:action="@{/updateOrderCategory/{id}(id=${order.id})}"
                          method="post" class="d-inline">
                        <select name="categoryId" class="form-select-sm me-2" onchange="this.form.submit()">
                            <option value="">Без категории</option>
                            <option th:each="category : ${categories}"
                                    th:value="${category.id}"
                                    th:selected="${order.category != null and order.category.id == category.id}"
                                    th:text="${category.name}">
                            </option>
                        </select>
                    </form>

                    <!-- Назначение механика - только MANAGER и ADMIN -->
                    <form th:action="@{/assignMechanic/{id}(id=${order.id})}"
                          method="post" class="d-inline"
                          sec:authorize="hasRole('MANAGER') or hasRole('ADMIN')">
                        <input type="text" name="mechanic" class="form-control-sm me-2" placeholder="Механик" th:value="${order.assignedMechanic}">
                        <button type="submit" class="btn btn-info btn-sm">
                            <i class="fas fa-user-cog"></i> Назначить
                        </button>
                    </form>

                    <!-- Обновление стоимости - только MANAGER и ADMIN -->
                    <form th:action="@{/updateCost/{id}(id=${order.id})}"
                          method="post" class="d-inline"
                          sec:authorize="hasRole('MANAGER') or hasRole('ADMIN')">
                        <input type="number" name="cost" class="form-control-sm me-2" placeholder="Стоимость" step="0.01" th:value="${order.cost}">
                        <button type="submit" class="btn btn-warning btn-sm">
                            <i class="fas fa-ruble-sign"></i> Стоимость
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Сообщение если нет заказов -->
    <div th:if="${#lists.isEmpty(orders)}" class="text-center py-5">
        <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
        <h4 class="text-muted" sec:authorize="hasRole('CLIENT')">У вас пока нет заказов</h4>
        <h4 class="text-muted" sec:authorize="!hasRole('CLIENT')">Нет активных заказов</h4>
        <p class="text-muted">Обратитесь к менеджеру для создания заказа</p>
    </div>

    <!-- Форма добавления нового заказа - RECEPTION, MANAGER, ADMIN -->
    <div class="mt-5" sec:authorize="hasRole('RECEPTION') or hasRole('MANAGER') or hasRole('ADMIN')">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-plus-circle"></i> Добавить новый заказ</h5>
            </div>
            <div class="card-body">
                <form th:action="@{/addOrder}" method="post">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="clientName" class="form-label">Имя клиента:</label>
                                <input type="text" class="form-control" id="clientName" name="clientName" required>
                            </div>

                            <div class="mb-3">
                                <label for="carModel" class="form-label">Модель автомобиля:</label>
                                <input type="text" class="form-control" id="carModel" name="carModel" required>
                            </div>

                            <div class="mb-3">
                                <label for="licensePlate" class="form-label">Госномер:</label>
                                <input type="text" class="form-control" id="licensePlate" name="licensePlate" required>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="description" class="form-label">Описание работ:</label>
                                <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
                            </div>

                            <div class="mb-3">
                                <label for="deadline" class="form-label">Срок выполнения:</label>
                                <input type="datetime-local" class="form-control" id="deadline" name="deadline">
                            </div>

                            <!-- Выбор категории для всех кто может добавлять заказы -->
                            <div class="mb-3">
                                <label for="categoryId" class="form-label">Категория:</label>
                                <select name="categoryId" class="form-control" id="categoryId">
                                    <option value="">Без категории</option>
                                    <option th:each="category : ${categories}"
                                            th:value="${category.id}"
                                            th:text="${category.name}">
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Добавить заказ
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения удаления -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Вы уверены, что хотите удалить заказ "<span id="orderTitle"></span>"?</p>
                <p class="text-danger"><small>Это действие нельзя отменить.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <a id="confirmDelete" href="#" class="btn btn-danger">Удалить</a>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var deleteModal = document.getElementById('deleteModal');
        deleteModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var orderId = button.getAttribute('data-bs-order-id');
            var orderTitle = button.getAttribute('data-bs-order-title');

            document.getElementById('orderTitle').textContent = orderTitle;
            document.getElementById('confirmDelete').href = '/deleteOrder/' + orderId;
        });
    });
</script>
</body>
</html>